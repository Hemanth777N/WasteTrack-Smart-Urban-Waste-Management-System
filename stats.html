<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>WasteTrack â€” Stats</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link rel="stylesheet" href="/style.css">
  <style>
    /* quick styles for cards/grid */
    .grid { 
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
        gap: 1rem;
    }
    /* .card is already in your style.css, so we just adjust it */
    .card { 
        flex: 1 1 350px; 
        margin-bottom: 0; /* Already has gap */
    }
    canvas { 
        max-width: 100%; 
        height: 320px; 
    }
    #overview p { 
        font-size: 1.2rem; 
        margin: 0.5rem 0; 
        text-align: left; 
    }
    #overview ul {
        text-align: left;
        padding-left: 2rem;
        font-size: 1.1rem;
    }
    /* Ensure table in card doesn't overflow */
    .table-scroll-wrapper {
        max-height: 400px; /* Add a max-height for scroll */
        overflow-y: auto;
    }
    table {
        width: 100%;
        min-width: 0; /* Override min-width from style.css */
    }
  </style>
</head>
<body>
  <div class="page-container">
    <h2>Public Statistics</h2>

    <div class="grid">
      <div class="card">
        <h3>Vehicle Usage</h3>
        <canvas id="vehiclePie"></canvas>
      </div>

      <div class="card">
        <h3>Waste Collected per Route (Total Kg)</h3>
        <canvas id="wasteBar"></canvas>
      </div>

      <div class="card">
        <h3>Overview</h3>
        <div id="overview" style="padding: 1rem;">
          <div class="loader-container"><span class="loader"></span></div>
        </div>
      </div>
    </div>

    <!-- Tables from Views -->
    <div class="card">
      <h3>Employee Performance (v_employee_performance)</h3>
      <div class="table-scroll-wrapper">
        <table id="viewEmpPerfTable"><thead></thead><tbody></tbody></table>
      </div>
    </div>

    <div class="card">
      <h3>Department Summary (v_department_summary)</h3>
      <div class="table-scroll-wrapper">
        <table id="viewDeptTable"><thead></thead><tbody></tbody></table>
      </div>
    </div>

    <div class="card">
      <h3>Pending Complaints (v_pending_complaints)</h3>
      <div class="table-scroll-wrapper">
        <table id="viewPendingTable"><thead></thead><tbody></tbody></table>
      </div>
    </div>
  </div>

  <script>
    async function fetchJson(url){ 
        const r = await fetch(url); 
        if (!r.ok) throw new Error(`Failed to fetch ${url}`);
        return r.json(); 
    }

    /**
     * Generic function to populate a table from a view
     */
    async function loadView(viewName, tableId) {
      const table = document.getElementById(tableId);
      if (!table) return;
      const thead = table.querySelector('thead');
      const tbody = table.querySelector('tbody');
      tbody.innerHTML = '<tr><td colspan="99" class="loader-container"><span class="loader"></span></td></tr>';
      try {
        const data = await fetchJson('/api/views/' + viewName);
        thead.innerHTML = '';
        tbody.innerHTML = '';
        if (!Array.isArray(data) || !data.length) {
          tbody.innerHTML = '<tr><td colspan="99">No data found for this view.</td></tr>';
          return;
        }
        const headerRow = document.createElement('tr');
        Object.keys(data[0]).forEach(key => {
          const th = document.createElement('th');
          th.textContent = key;
          headerRow.appendChild(th);
        });
        thead.appendChild(headerRow);
        data.forEach(row => {
          const tr = document.createElement('tr');
          Object.values(row).forEach(val => {
            const td = document.createElement('td');
            td.textContent = val;
            tr.appendChild(td);
          });
          tbody.appendChild(tr);
        });
      } catch (e) {
        console.error(`Failed to load view ${viewName}:`, e);
        tbody.innerHTML = `<tr><td colspan="99" style="color:red;">Error loading data.</td></tr>`;
      }
    }

    async function renderCharts() {
      try {
        // vehicle usage -> use view v_vehicle_usage
        const vehicles = await fetchJson('/api/views/v_vehicle_usage');
        const labelsV = vehicles.map(v => v.vehicle_no + ' (' + v.vehicle_type + ')').slice(0, 8);
        const valuesV = vehicles.map(v => Number(v.total_assignments)).slice(0, 8);

        new Chart(document.getElementById('vehiclePie'), {
          type: 'pie',
          data: { labels: labelsV, datasets: [{ data: valuesV, backgroundColor: ['#2ecc71', '#3498db', '#9b59b6', '#f1c40f', '#e74c3c', '#778ca3'] }] },
          options: { responsive: true, plugins: { legend: { position: 'right' } } }
        });
      } catch (e) { console.error('Failed to load vehicle chart:', e); }

      try {
        // waste per route -> use view v_waste_collection_stats
        const waste = await fetchJson('/api/views/v_waste_collection_stats');
        const labelsW = waste.map(r => r.route_name);
        const valuesW = waste.map(r => Number(r.total_collected_kg) || 0);
        new Chart(document.getElementById('wasteBar'), {
          type: 'bar',
          data: { labels: labelsW, datasets: [{ label: 'Total kg', data: valuesW, backgroundColor: '#2ecc71' }] },
          options: { responsive: true, scales: { y: { beginAtZero: true } } }
        });
      } catch (e) { console.error('Failed to load waste chart:', e); }

      try {
        // overview -> use new /api/stats/overview
        const ov = await fetchJson('/api/stats/overview');
        const ovDiv = document.getElementById('overview');
        ovDiv.innerHTML = `
          <p>Pending Complaints: <strong>${ov.pending}</strong></p>
          <p>Resolved/Closed: <strong>${ov.resolved}</strong></p>
          <hr style="margin: 1rem 0;">
          <p><strong>Top Vehicles (by # of jobs):</strong></p>
          <ul>
            ${ov.vehicleUsage.map(v => `<li>${v.vehicle_no} (${v.total_assignments} jobs)</li>`).slice(0, 3).join('')}
          </ul>
        `;
      } catch (e) { console.error('Failed to load overview:', e); }
    }

    // Load all data on page start
    document.addEventListener('DOMContentLoaded', () => {
        renderCharts();
        // Load tables
        loadView('v_employee_performance', 'viewEmpPerfTable');
        loadView('v_department_summary', 'viewDeptTable');
        loadView('v_pending_complaints', 'viewPendingTable');
    });
  </script>
</body>
</html>