<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>WasteTrack - Submit Complaint</title>
    <link rel="stylesheet" href="style.css">
</head>

<body>
    <h2>Submit Waste Complaint</h2>
    <form id="complaintForm">
        <label>Name: <input type="text" name="citizen_name" required></label>
        <label>Contact No: <input type="text" name="contact_no" required></label>
        <label>Location: <input type="text" name="location" required></label>
        <label>Description: <textarea name="description" required></textarea></label>
        <button type="submit">Submit</button>
    </form>

    <h3>All Complaints</h3>
    <table id="complaintsTable">
        <thead>
            <tr>
                <th>ID</th>
                <th>Name</th>
                <th>Contact</th>
                <th>Location</th>
                <th>Description</th>
                <th>Status</th>
                <th>Date</th>
            </tr>
        </thead>
        <tbody>
            <!-- Complaints will be loaded here -->
        </tbody>
    </table>

    <script>
        async function loadComplaints() {
            try {
                const res = await fetch('/api/complaints');
                const data = await res.json();
                const tbody = document.querySelector('#complaintsTable tbody');
                tbody.innerHTML = '';
                if (Array.isArray(data)) {
                    data.forEach(c => {
                        tbody.innerHTML += `<tr>
                            <td>${c.complaint_id}</td>
                            <td>${c.citizen_name}</td>
                            <td>${c.contact_no}</td>
                            <td>${c.location}</td>
                            <td>${c.description}</td>
                            <td>${c.status}</td>
                            <td>${c.complaint_date ? c.complaint_date.substring(0, 10) : ''}</td>
                        </tr>`;
                    });
                } else {
                    tbody.innerHTML = `<tr><td colspan="7" style="color:red;">Error loading complaints</td></tr>`;
                }
            } catch (e) {
                const tbody = document.querySelector('#complaintsTable tbody');
                tbody.innerHTML = `<tr><td colspan="7" style="color:red;">Error loading complaints: ${e}</td></tr>`;
            }
        }

        document.getElementById('complaintForm').addEventListener('submit', async function (e) {
            e.preventDefault();
            const form = e.target;
            const data = {
                citizen_name: form.citizen_name.value,
                contact_no: form.contact_no.value,
                location: form.location.value,
                description: form.description.value
            };
            const res = await fetch('/api/complaints', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
            if (res.ok) {
                alert('Complaint submitted successfully!');
                form.reset();
                loadComplaints();
            } else {
                alert('Error submitting complaint.');
            }
        });

        loadComplaints();
    </script>
</body>

</html>